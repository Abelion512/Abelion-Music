<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abelion Music Player</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="icon" href="Icon.jpg" type="image/jpg">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .bg-video, .bg-blur {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      object-fit: cover;
      width: 100%; height: 100%;
      z-index: -1;
      transition: opacity 0.6s ease;
    }
    .hidden {
      opacity: 0;
      pointer-events: none;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      position: relative;
    }
    .back-button, .menu-button {
      position: absolute;
      top: 1rem;
      background: #222;
      border: none;
      color: white;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .back-button { left: 1rem; }
    .menu-button { right: 1rem; font-size: 1.5rem; }
    .popup-menu {
      position: absolute;
      top: 3rem; right: 1rem;
      background: #222;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      padding: 0.5rem;
      gap: 0.5rem;
      z-index: 100;
    }
    .popup-menu button {
      background: none;
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      text-align: left;
      border-radius: 5px;
      transition: background 0.2s;
      cursor: pointer;
    }
    .popup-menu button:hover { background: #333; }
    .album-art {
      width: 80%;
      max-width: 300px;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">ğŸ“± Offline Mode</div>

  <video autoplay muted loop id="bgVideo" class="bg-video">
    <source src="video/doit_bg.mp4" type="video/mp4" />
  </video>
  <img src="image/doit.jpeg" class="bg-blur" id="bgImage" />

  <div class="container" id="playerContainer">
    <button class="back-button" onclick="window.location.href='index.html'">&lt;</button>
    <button class="menu-button" onclick="toggleMenu()">â‹®</button>

    <div class="popup-menu" id="popupMenu">
      <button onclick="toggleVideo()">ğŸ¥ Toggle Video</button>
      <button onclick="showVolumeControl()">ğŸ”Š Volume</button>
      <button onclick="downloadSong()">ğŸ“¥ Download</button>
      <button onclick="shareSong()">ğŸ“¤ Share</button>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <img id="albumArt" class="album-art" src="image/doit.jpeg" alt="cover" />

    <div class="song-info">
      <h2 id="title">Loading...</h2>
      <p id="artist">Please wait...</p>
    </div>

    <div class="progress-container">
      <span id="currentTime">0:00</span>
      <input type="range" id="seekBar" value="0" min="0" />
      <span id="duration">0:00</span>
    </div>

    <div class="volume-slider" id="volumeSlider" style="display: none;">
      <input type="range" id="volumeBar" value="100" min="0" max="100" />
    </div>

    <div class="controls">
      <button id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">ğŸ”€</button>
      <button onclick="prevSong()" title="Previous">â®</button>
      <button class="main" onclick="togglePlayPause()" id="playPause" title="Play/Pause">â–¶</button>
      <button onclick="nextSong()" title="Next">â­</button>
      <button id="repeatBtn" onclick="toggleRepeat()" title="Repeat">ğŸ”</button>
    </div>

    <div class="lyric-toggle" onclick="toggleLyrics()">Show Lyrics</div>

    <div class="lyric-popup" id="lyricPopup">
      <button class="lyric-back" onclick="toggleLyrics()">â† Back</button>
      <div id="lyricLines"></div>
    </div>
  </div>

  <audio id="audio" preload="metadata"></audio>
<script>
const audio = document.getElementById("audio");
const playPause = document.getElementById("playPause");
const title = document.getElementById("title");
const artist = document.getElementById("artist");
const albumArt = document.getElementById("albumArt");
const bgVideo = document.getElementById("bgVideo");
const bgImage = document.getElementById("bgImage");
const seekBar = document.getElementById("seekBar");
const volumeBar = document.getElementById("volumeBar");
const volumeSlider = document.getElementById("volumeSlider");
const currentTime = document.getElementById("currentTime");
const duration = document.getElementById("duration");
const lyricPopup = document.getElementById("lyricPopup");
const lyricLines = document.getElementById("lyricLines");
const shuffleBtn = document.getElementById("shuffleBtn");
const repeatBtn = document.getElementById("repeatBtn");
const popupMenu = document.getElementById("popupMenu");
const offlineIndicator = document.getElementById("offlineIndicator");
const errorMessage = document.getElementById("errorMessage");

const songs = [
  { title: "Unconditionally", artist: "Katy Perry", file: "music/lagu1.mp3" },
  { title: "Rewrite the Stars", artist: "James Arthur & Anne-Marie", file: "music/lagu2.mp3" },
  { title: "Yad", artist: "Ariana Grande", file: "music/lagu3.mp3" },
  { title: "I'll Do It", artist: "Heidi Montag", file: "music/lagu4.mp3" },
  { title: "On The Floor", artist: "JLo ft Pitbull", file: "music/lagu5.mp3" },
  { title: "Stereo Love", artist: "Unknown", file: "music/lagu6.mp3" }
];

let currentIndex = parseInt(localStorage.getItem("selectedIndex")) || 0;
let repeatMode = 0;
let isShuffle = false;
let showVideo = false;
let lyrics = [];
let isPlaying = false;

function showError(msg) {
  errorMessage.textContent = msg;
  errorMessage.classList.add("show");
  setTimeout(() => errorMessage.classList.remove("show"), 3000);
}

function formatTime(t) {
  if (isNaN(t)) return "0:00";
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60).toString().padStart(2, "0");
  return `${m}:${s}`;
}

function loadSong(index) {
  const song = songs[index];
  title.textContent = song.title;
  artist.textContent = song.artist;
  audio.src = song.file;
  albumArt.src = "image/doit.jpeg";
  lyrics = getLyrics(song.title);
  updateLyrics(0);
  localStorage.setItem("selectedIndex", index);
}

function togglePlayPause() {
  if (audio.paused) {
    audio.play().then(() => {
      playPause.textContent = "â¸";
      isPlaying = true;
    }).catch(e => showError("âŒ Error: Audio cannot be played."));
  } else {
    audio.pause();
    playPause.textContent = "â–¶";
    isPlaying = false;
  }
}

function nextSong() {
  currentIndex = isShuffle ? Math.floor(Math.random() * songs.length) : (currentIndex + 1) % songs.length;
  loadSong(currentIndex);
  if (isPlaying) audio.play();
}

function prevSong() {
  currentIndex = isShuffle ? Math.floor(Math.random() * songs.length) : (currentIndex - 1 + songs.length) % songs.length;
  loadSong(currentIndex);
  if (isPlaying) audio.play();
}

function toggleRepeat() {
  repeatMode = (repeatMode + 1) % 3;
  repeatBtn.classList.toggle("active", repeatMode !== 0);
  repeatBtn.textContent = repeatMode === 2 ? "ğŸ”‚" : "ğŸ”";
  repeatBtn.title = ["Repeat Off", "Repeat All", "Repeat One"][repeatMode];
}

function toggleShuffle() {
  isShuffle = !isShuffle;
  shuffleBtn.classList.toggle("active", isShuffle);
  shuffleBtn.title = isShuffle ? "Shuffle On" : "Shuffle Off";
}

function toggleMenu() {
  popupMenu.style.display = popupMenu.style.display === "flex" ? "none" : "flex";
}

function toggleVideo() {
  showVideo = !showVideo;
  bgVideo.classList.toggle("hidden", !showVideo);
  bgImage.classList.toggle("hidden", showVideo);
  albumArt.classList.toggle("hidden", showVideo);
  localStorage.setItem("showVideo", showVideo);
}

function showVolumeControl() {
  volumeSlider.style.display = volumeSlider.style.display === "none" ? "block" : "none";
}

function downloadSong() {
  const song = songs[currentIndex];
  const a = document.createElement("a");
  a.href = song.file;
  a.download = `${song.title}.mp3`;
  a.click();
}

function shareSong() {
  const song = songs[currentIndex];
  const text = `Now playing: ${song.title} by ${song.artist}`;
  if (navigator.share) {
    navigator.share({ title: song.title, text, url: location.href }).catch(() => {});
  } else if (navigator.clipboard) {
    navigator.clipboard.writeText(`${text} - ${location.href}`).then(() => showError("ğŸ“‹ Link copied!"));
  } else {
    showError("Sharing not supported.");
  }
}

function updateLyrics(currentTime) {
  if (!lyrics.length) return;
  lyricLines.innerHTML = lyrics.map((line, i) => {
    const nextTime = lyrics[i + 1]?.time || Infinity;
    const active = currentTime >= line.time && currentTime < nextTime;
    return `<div class="lyric-line${active ? " active" : ""}" onclick="audio.currentTime=${line.time}">${line.text}</div>`;
  }).join("");
  const activeLine = lyricLines.querySelector(".lyric-line.active");
  if (activeLine) activeLine.scrollIntoView({ behavior: "smooth", block: "center" });
}

function getLyrics(title) {
  const lyricDB = {
    "Unconditionally": [
      { time: 0, text: "ğŸµ Unconditionally - Katy Perry" },
      { time: 4, text: "Let me show you my full devotion..." }
    ],
    "I'll Do It": [
      { time: 0, text: "ğŸµ I'll Do It - Heidi Montag" },
      { time: 5, text: "I'm gonna show you what I'm made of..." }
    ]
  };
  return lyricDB[title] || [{ time: 0, text: "No lyrics available." }];
}

function toggleLyrics() {
  lyricPopup.classList.toggle("show");
}

audio.addEventListener("loadedmetadata", () => {
  seekBar.max = audio.duration;
  duration.textContent = formatTime(audio.duration);
});
audio.addEventListener("timeupdate", () => {
  seekBar.value = audio.currentTime;
  currentTime.textContent = formatTime(audio.currentTime);
  updateLyrics(audio.currentTime);
});
audio.addEventListener("ended", () => {
  if (repeatMode === 2) {
    audio.currentTime = 0;
    audio.play();
  } else if (repeatMode === 1 || currentIndex < songs.length - 1) {
    nextSong();
  } else {
    playPause.textContent = "â–¶";
    isPlaying = false;
  }
});
seekBar.addEventListener("input", () => {
  audio.currentTime = seekBar.value;
});
volumeBar.addEventListener("input", () => {
  audio.volume = volumeBar.value / 100;
  localStorage.setItem("volume", volumeBar.value);
});

function updateOnlineStatus() {
  offlineIndicator.classList.toggle("show", !navigator.onLine);
}
window.addEventListener("online", updateOnlineStatus);
window.addEventListener("offline", updateOnlineStatus);

// Startup init
function initPlayer() {
  const savedVolume = localStorage.getItem("volume") || 100;
  volumeBar.value = savedVolume;
  audio.volume = savedVolume / 100;
  showVideo = localStorage.getItem("showVideo") === "true";
  if (showVideo) toggleVideo();
  loadSong(currentIndex);
  document.addEventListener("click", e => {
    if (!popupMenu.contains(e.target) && !e.target.classList.contains("menu-button")) {
      popupMenu.style.display = "none";
    }
  });
}
initPlayer();
</script>
</body>
</html>
